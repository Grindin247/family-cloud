version: '3.8'

# Must run the following commands before running docker compose up.
#     $ openssl req -x509 -nodes -days 365   -newkey rsa:2048   -keyout certs/wildcard..key   -out certs/wildcard..crt   -subj "/CN=*."   -addext "subjectAltName=DNS:*.,DNS:family"
#     $ docker volume create nextcloud_aio_mastercontainer
#     $ docker network create --subnet=172.20.0.0/24 --driver=bridge familynet
#
# If using WSL2 set the fallback DNS to the window host gateway IP address in the Corefile.
# Update router DNS settings to point to the WSL2 host IP.

services:

  traefik:
    # Use a recent Traefik v3.x to match modern Docker API versions
    image: traefik:v3.3
    environment:
      # Some environments enforce a higher minimum Docker API version.
      # Force Traefik's Docker client to use a modern API.
      - DOCKER_API_VERSION=1.53
    container_name: traefik
    command:
      - --api.dashboard=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.filename=/etc/traefik/dynamic.yml
      - --providers.file.watch=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic:/etc/traefik/dynamic:ro
      - ./certs:/certs:ro
      # Docker socket not needed in file-provider-only mode
      # - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${FAMILY_DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth"
      - "traefik.http.middlewares.auth.forwardauth.address=http://auth:4181"
      - "traefik.http.middlewares.auth.forwardauth.trustforwardheader=true"
      - "traefik.http.middlewares.auth.forwardauth.authresponseheaders=X-Forwarded-User"
    networks:
      familynet:
        ipv4_address: 172.20.0.10
    dns:
      - 172.20.0.11

  auth:
    image: thomseddon/traefik-forward-auth
    container_name: auth
    environment:
      - DEFAULT_PROVIDER=oidc
      # Dev/no-router mode: use HTTP issuer via Traefik
      - PROVIDERS_OIDC_ISSUER_URL=http://keycloak.${FAMILY_DOMAIN}/realms/${KEYCLOAK_REALM}
      - PROVIDERS_OIDC_CLIENT_ID=traefik-forward-auth
      - PROVIDERS_OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - SECRET=${FORWARD_AUTH_COOKIE_SECRET}

      # HTTP mode requires non-secure cookies
      - INSECURE_COOKIE=true
      # Use base domain for cookie scope
      - COOKIE_DOMAIN=${FAMILY_DOMAIN}

      - AUTH_HOST=auth.${FAMILY_DOMAIN}
      - LOG_LEVEL=debug
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=Host(`auth.${FAMILY_DOMAIN}`)"
      - "traefik.http.routers.auth.entrypoints=websecure"
      - "traefik.http.routers.auth.tls=true"
      - "traefik.http.services.auth.loadbalancer.server.port=4181"
    depends_on:
      keycloak:
        condition: service_healthy
    volumes:
      - ./certs/wildcard.${FAMILY_DOMAIN}.crt:/etc/ssl/certs/wildcard.${FAMILY_DOMAIN}.crt:ro
    networks:
      - familynet
    dns:
      - 172.20.0.11
    
  ldap:
    image: lldap/lldap:latest
    container_name: ldap
    environment:
      - LLDAP_JWT_SECRET=${LLDAP_JWT_SECRET}
      - LLDAP_LDAP_BASE_DN=dc=example,dc=com
      - LLDAP_LDAP_USER_PASS=${LLDAP_ADMIN_PASSWORD}
    volumes:
      - lldap_data:/data
    ports:
      - "3890:3890"
      - "17170:17170"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ldap.rule=Host(`ldap.${FAMILY_DOMAIN}`)"
      - "traefik.http.routers.ldap.entrypoints=websecure"
      - "traefik.http.routers.ldap.tls=true"
      - "traefik.http.services.ldap.loadbalancer.server.port=17170"
    networks:
      - familynet
    dns:
      - 172.20.0.11

  coredns:
    image: coredns/coredns:latest
    container_name: coredns
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./Corefile:/Corefile:ro
    # No-router-change mode:
    # Don't bind to host :53 (often already used by systemd-resolved).
    # Bind to 1053 instead for debugging, or remove ports entirely.
    ports:
      - "1053:53/udp"
      - "1053:53/tcp"
    restart: unless-stopped
    networks:
      familynet:
        ipv4_address: 172.20.0.11
    dns:
      - 172.20.0.11

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    command: start-dev
    depends_on:
      ldap:
        condition: service_healthy
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      # Dev/no-router-change mode:
      # Set Keycloak's advertised hostname to the external hostname so browser redirects are valid.
      - KC_HOSTNAME=keycloak.${FAMILY_DOMAIN}
      - KC_HTTP_ENABLED=true
      - KC_PROXY=edge
      - KC_HOSTNAME_STRICT=false
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./keycloak-config.sh:/opt/keycloak/keycloak-config.sh:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.${FAMILY_DOMAIN}`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls=true"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
    entrypoint: >
      bash -c "
        /opt/keycloak/bin/kc.sh start-dev &
        until echo > /dev/tcp/localhost/8080 2>/dev/null; do echo 'Waiting for Keycloak...'; sleep 2; done;

        if [ ! -f /opt/keycloak/data/.configured ]; then
          echo 'Running initial Keycloak configuration...'
          bash /opt/keycloak/keycloak-config.sh && touch /opt/keycloak/data/.configured
        else
          echo 'Keycloak has already been configured. Skipping config.'
        fi

        wait"
    healthcheck:
      test: ["CMD", "sh", "-c", "echo > /dev/tcp/localhost/8080"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - familynet
    dns:
      - 172.20.0.11

  nextcloud-aio-mastercontainer:
    image: nextcloud/all-in-one:latest
    # Nextcloud container name name must be nextcloud_aio_mastercontainer
    container_name: nextcloud-aio-mastercontainer
    restart: unless-stopped
    privileged: true
    # Expose the AIO setup UI on the host. This does NOT conflict with Traefik.
    ports:
      - "8080:8080"
    volumes:
      - nextcloud_aio_mastercontainer:/mnt/docker-aio-config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - NEXTCLOUD_DATADIR=/mnt/ncdata
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=admin
      - APACHE_PORT=11000
      - APACHE_IP_BINDING=0.0.0.0
      - APACHE_ADDITIONAL_NETWORK=familynet
      - SKIP_DOMAIN_VALIDATION=true
      # NOTE: AIO does not support NEXTCLOUD_TRUSTED_DOMAINS env var; keep domain setup inside AIO UI
      # - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.${FAMILY_DOMAIN}
      - NEXTCLOUD_WOPI_SKIP_SSL_VERIFY=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloudsetup.rule=Host(`nextcloudsetup.${FAMILY_DOMAIN}`)"
      - "traefik.http.routers.nextcloudsetup.entrypoints=websecure"
      - "traefik.http.routers.nextcloudsetup.tls=true"
      - "traefik.http.routers.nextcloudsetup.service=nextcloudsetup"
      - "traefik.http.services.nextcloudsetup.loadbalancer.server.port=8080"
      - "traefik.http.services.nextcloudsetup.loadbalancer.server.scheme=https"
    networks:
      familynet:
        ipv4_address: 172.20.0.12
    dns:
      - 172.20.0.11
    depends_on:
      keycloak:
        condition: service_healthy

  # --- Agent task tracking (Kanban) ---
  # Vikunja: https://vikunja.io
  # Enable with: docker compose --profile ops up -d
  vikunja-db:
    image: postgres:16
    container_name: vikunja-db
    profiles: ["ops"]
    environment:
      - POSTGRES_PASSWORD=${VIKUNJA_DB_PASSWORD:-vikunja}
      - POSTGRES_USER=${VIKUNJA_DB_USER:-vikunja}
      - POSTGRES_DB=${VIKUNJA_DB_NAME:-vikunja}
      - TZ=${TZ}
    volumes:
      - vikunja_db:/var/lib/postgresql/data
    networks:
      - familynet
    dns:
      - 172.20.0.11

  vikunja:
    # Combined Vikunja image (frontend + api)
    image: vikunja/vikunja:latest
    container_name: vikunja
    profiles: ["ops"]
    depends_on:
      - vikunja-db
    # Image runs as non-root; mount writable volumes and set a writable cache dir
    user: "0:0"
    environment:
      - VIKUNJA_DATABASE_TYPE=postgres
      - VIKUNJA_DATABASE_HOST=vikunja-db
      - VIKUNJA_DATABASE_USER=${VIKUNJA_DB_USER:-vikunja}
      - VIKUNJA_DATABASE_PASSWORD=${VIKUNJA_DB_PASSWORD:-vikunja}
      - VIKUNJA_DATABASE_DATABASE=${VIKUNJA_DB_NAME:-vikunja}
      - VIKUNJA_SERVICE_JWTSECRET=${VIKUNJA_JWT_SECRET:-change-me}
      - VIKUNJA_SERVICE_PUBLICURL=https://tasks.${FAMILY_DOMAIN}
      - VIKUNJA_SERVICE_ENABLEREGISTRATION=${VIKUNJA_ENABLE_REGISTRATION:-false}
      - XDG_CACHE_HOME=/tmp/.cache
      - TZ=${TZ}
    volumes:
      - vikunja_files:/app/vikunja/files
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tasks.rule=Host(`tasks.${FAMILY_DOMAIN}`)"
      - "traefik.http.routers.tasks.entrypoints=websecure"
      - "traefik.http.routers.tasks.tls=true"
      - "traefik.http.routers.tasks.middlewares=auth"
      - "traefik.http.services.tasks.loadbalancer.server.port=3456"
    networks:
      - familynet
    dns:
      - 172.20.0.11

volumes:
  lldap_data:
  keycloak_data:
  vikunja_db:
  vikunja_files:
  # Nextcloud volume name must match the one used in the Nextcloud AIO container.
  nextcloud_aio_mastercontainer:
    external: true

networks:
  familynet:
    external: true